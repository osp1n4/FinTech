# HUMAN REVIEW (Maria Paula Gutierrez):
# Pipeline completo con Build, Tests y SonarQube.
# Cumple con requisitos de Cultura DevOps (Semana 3).
name: CI - Tests, Coverage & SonarQube

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "hotfix/**"
  pull_request:
    branches:
      - main
      - develop

env:
  PYTHON_VERSION: "3.11"
  MIN_COVERAGE: 70

jobs:
  # =====================================================
  # FASE 1: BUILD
  # =====================================================
  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Instalar Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: ðŸ” Verificar instalaciÃ³n Poetry
        run: poetry --version
      
      - name: ðŸ“¦ Instalar dependencias
        run: poetry install --no-interaction --no-ansi
      
      - name: âœ… Verificar imports
        run: |
          poetry run python -c "import fastapi; import pydantic; print('âœ… Dependencias OK')"

  # =====================================================
  # FASE 2: TESTS Y COBERTURA
  # =====================================================
  test-backend:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          # âš ï¸ En producciÃ³n, usar GitHub Secrets
          MONGO_INITDB_ROOT_PASSWORD: ${{ secrets.MONGODB_TEST_PASSWORD || 'test_password_2026' }}
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3.12-alpine
        ports:
          - 5672:5672
        env:
          RABBITMQ_DEFAULT_USER: fraud
          # âš ï¸ En producciÃ³n, usar GitHub Secrets
          RABBITMQ_DEFAULT_PASS: ${{ secrets.RABBITMQ_TEST_PASSWORD || 'test_password_2026' }}
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ðŸ“¦ Instalar Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: ðŸ“¦ Instalar dependencias
        run: poetry install --no-interaction --no-ansi

      - name: ðŸ”§ Configurar PYTHONPATH
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: ðŸ§ª Ejecutar tests unitarios
        run: |
          poetry run pytest tests/unit/ \
            --cov=services \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=${{ env.MIN_COVERAGE }} \
            -v --tb=short
        env:
          # âš ï¸ Credenciales deben estar en GitHub Secrets en producciÃ³n
          MONGODB_URL: mongodb://admin:${{ secrets.MONGODB_TEST_PASSWORD || 'test_password_2026' }}@localhost:27017
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://fraud:${{ secrets.RABBITMQ_TEST_PASSWORD || 'test_password_2026' }}@localhost:5672

      - name: ðŸ“Š Verificar cobertura
        run: |
          echo "âœ… Tests unitarios pasaron"
          echo "ðŸ“Š Cobertura mÃ­nima: ${{ env.MIN_COVERAGE }}%"
          if [ -f coverage.xml ]; then
            echo "âœ… Reporte de cobertura generado"
          fi

      - name: ðŸ“¤ Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-backend
          path: |
            coverage.xml
            htmlcov/
          retention-days: 7

  # =====================================================
  # FASE 3: SONARQUBE (solo si tests pasan)
  # =====================================================
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [test-backend]
    if: success()
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: ðŸ“¥ Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-backend

      - name: ðŸ“ Organizar archivos de cobertura
        run: |
          echo "ðŸ“¦ Verificando reportes de cobertura..."
          if [ -f coverage.xml ]; then
            echo "âœ… coverage.xml encontrado ($(du -h coverage.xml | cut -f1))"
          else
            echo "âŒ coverage.xml NO encontrado"
          fi
          
          echo ""
          echo "ðŸ“‹ Archivos disponibles:"
          ls -lh
      
      - name: ðŸ” SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_SCANNER_OPTS: "-Xmx512m"
        continue-on-error: true
      
      - name: âœ… Resumen
        if: always()
        # âš ï¸ Variables sanitizadas para evitar inyecciÃ³n de cÃ³digo
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "================================================"
          echo "ðŸ“Š RESUMEN DEL PIPELINE"
          echo "================================================"
          echo "Tipo de evento: $EVENT_NAME"
          echo "Rama: $REF_NAME"
          if [ "$EVENT_NAME" == "pull_request" ]; then
            echo "PR: $PR_NUMBER"
            echo "Base: $PR_BASE_REF"
            echo "Head: $PR_HEAD_REF"
          fi
          echo "================================================"
          echo "âœ… Build completado"
          echo "âœ… Tests ejecutados"
          echo "âœ… Cobertura verificada (>= ${{ env.MIN_COVERAGE }}%)"
          echo "âœ… SonarQube ejecutado"
          echo "================================================"


